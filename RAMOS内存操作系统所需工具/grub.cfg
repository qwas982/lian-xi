# ==================== 基础设置 ====================
# 设置中文环境和图形模式
set timeout=5
set locale_dir=$prefix/locale
set lang=zh_CN
loadfont $prefix/fonts/unicode.pf2
terminal_output gfxterm

# 设置GRUB的根设备为当前配置文件所在分区（ESP分区），确保后续insmod能正确加载模块
search --no-floppy --fs-uuid --set=root uuid
# 或者，如果不想用UUID，可以注释上一行，改用自动搜索配置文件所在分区
# search --set=root --file /EFI/MyGRUB/grub.cfg

# 设置模块和资源路径前缀，非常重要！
set prefix=($root)/boot/grub

# ==================== 加载必要模块 ====================
# 必须为map和ntboot提供文件系统驱动支持
insmod part_gpt
insmod part_msdos
insmod ntfs
insmod fat
insmod exfat
insmod ext2

# 加载核心功能模块
insmod search
insmod search_fs_file
insmod map
insmod ntboot
insmod chain
insmod wimboot
insmod vhd
insmod boot

# ==================== 主菜单：启动 VHDX 中的 Windows ====================
menuentry "启动RAMOS win vhd" --class windows {
    # 1. 自动搜索 VHDX 文件
    # 在(hd1)等所有硬盘上，递归搜索后缀为.vhdx的文件。
    # 将找到的第一个文件的路径存入'vhd_path'变量，并将其所在分区设为'root'。
    echo "正在找 VHDX 文件 ..."
    set vhd_path=path

    echo "正在检查VHDX文件: $vhd_path ..."
    # 检查文件是否存在
    if [ ! -f "$vhd_path" ]; then
        echo "错误：在 $vhd_path 未找到 VHDX 文件！"
        sleep --interruptible 5
        return
    fi
    
    # 注意：search命令会同时设置'vhd_path'和'root'变量。
    # 'root'现在指向VHDX文件所在的分区（例如你的D盘）。
    # 'vhd_path'是文件的完整GRUB路径，如(hd1,gpt3)/VHDs/win10.vhdx。

    # 2. 将 VHDX 文件映射到内存作为虚拟硬盘
    echo "正在把 VHD 文件载入到内存，请稍候..."
    # 使用 --mem 参数将整个文件载入内存，速度取决于文件大小和内存速度。
    # 使用 --rt 参数确保虚拟盘在操作系统加载后不被释放。
    map --mem --rt -l --type=HD "$vhd_path" --first (hd1)
    map --hook
    
    # 映射成功后，会创建一个新的虚拟硬盘设备（例如(hd1)）。

    # 3. 引导虚拟硬盘中的 Windows
    echo "正在启动 Windows ..."
    set gfxpayload=text
    terminal_output console    

    # 方法A: 使用ntboot命令（推荐，来自示例菜单）
    # 假设你的GRUB工具集中包含bootmgfw.efi
    
    # ntboot --gui --vhd --timeout=5 --win (hd1)

    # 方法B: 使用chainloader（更通用，但可能需要额外驱动）
    # 搜索虚拟硬盘上Windows的EFI引导文件
    # 如果知道虚拟硬盘内Windows引导文件的精确路径，也可以用chainloader
    
    chainloader (hd1,gpt1)/EFI/Microsoft/Boot/bootmgfw.efi
    boot
    
    # 注意：(hd1,gpt1)是假设虚拟硬盘的第一个分区是EFI系统分区。
    # 实际分区号可能不同，你可能需要尝试(hd1,1)或使用search命令查找。

    # 如果是传统BIOS启动的VHD，可能需要使用linux16/initrd16加载NT内核
    # 因复杂度高，此处不展开。通常UEFI环境使用上述方法即可。
}

menuentry "启动本地硬盘上的 Windows" {
    # 备用菜单项：直接启动本地硬盘上的Windows
    search --file --set=root /EFI/Microsoft/Boot/bootmgfw.efi
    chainloader /EFI/Microsoft/Boot/bootmgfw.efi
}

menuentry "重启" {
    reboot
}

menuentry "关机" {
    halt
}
