/**
 * 数据结构.h
 * WebAssembly 核心数据结构定义
 * 对应原 module.h
 */

#ifndef 数据结构_H
#define 数据结构_H

#include "枚举定义.h"
#include "类型定义.h"

/* ==================== 前向声明 ==================== */
struct 结构_模块;
struct 结构_解释器;

/* ==================== 栈值结构 ==================== */
/* 操作数栈中的值 */
struct 结构_栈值 {
    uint8_t 值类型;     /* 使用值类型_xxx */
    联合体_值 值;
};

typedef struct 结构_栈值 结构_栈值;

/* ==================== 栈帧结构 ==================== */
/* 调用栈帧 */
struct 结构_栈帧 {
    uint32_t 函数索引;
    uint32_t 返回地址;
    int32_t  局部变量基址;
    int32_t  操作数栈基址;
    int32_t  块栈基址;
    struct 结构_模块* 调用者模块;
};

typedef struct 结构_栈帧 结构_栈帧;

/* ==================== 控制块结构 ==================== */
/* 控制块（块/循环/条件） */
struct 结构_控制块 {
    uint8_t  块类型;        /* 使用块类型_xxx */
    uint8_t  返回类型;      /* 使用值类型_xxx，0xFF表示无返回值 */
    uint32_t 起始地址;
    uint32_t 结束地址;
    uint32_t 否则地址;      /* 仅用于条件块，0xFFFFFFFF表示无 */
    int      是循环;        /* 布尔值 */
};

typedef struct 结构_控制块 结构_控制块;

/* ==================== 函数类型结构 ==================== */
/* 函数类型定义 */
struct 结构_函数类型 {
    uint32_t 参数数;
    uint8_t* 参数类型;      /* 动态数组，每个元素是值类型 */
    uint32_t 返回数;
    uint8_t* 返回类型;      /* 动态数组，每个元素是值类型 */
};

typedef struct 结构_函数类型 结构_函数类型;

/* ==================== 内存结构 ==================== */
/* 线性内存 */
struct 结构_内存 {
    uint32_t 初始页数;
    uint32_t 最大页数;
    uint32_t 当前页数;
    uint8_t* 数据;          /* 动态分配的内存 */
    uint32_t 数据大小;      /* 当前数据大小（字节） */
};

typedef struct 结构_内存 结构_内存;

/* ==================== 表结构 ==================== */
/* 函数表 */
struct 结构_表 {
    uint32_t 初始大小;
    uint32_t 最大大小;
    uint32_t 当前大小;
    uint32_t* 元素;         /* 动态数组，存储函数索引 */
};

typedef struct 结构_表 结构_表;

/* ==================== 导出项结构 ==================== */
/* 导出项 */
struct 结构_导出项 {
    char*    名称;          /* 动态分配的字符串 */
    uint8_t  导出类型;      /* 使用导出类型_xxx */
    uint32_t 索引;
};

typedef struct 结构_导出项 结构_导出项;

/* ==================== 全局变量结构 ==================== */
/* 全局变量 */
struct 结构_全局变量 {
    uint8_t  值类型;        /* 使用值类型_xxx */
    联合体_值 值;
    int      可变;          /* 布尔值 */
};

typedef struct 结构_全局变量 结构_全局变量;

/* ==================== 数据段结构 ==================== */
/* 数据段 */
struct 结构_数据段 {
    uint32_t 内存索引;
    uint32_t 偏移量;
    uint8_t* 数据;          /* 动态分配的数据 */
    uint32_t 数据长度;
};

typedef struct 结构_数据段 结构_数据段;

/* ==================== 元素段结构 ==================== */
/* 元素段 */
struct 结构_元素段 {
    uint32_t 表索引;
    uint32_t 偏移量;
    uint32_t* 函数索引列表; /* 动态数组 */
    uint32_t 函数数;
};

typedef struct 结构_元素段 结构_元素段;

/* ==================== 导入项结构 ==================== */
/* 导入项 */
struct 结构_导入项 {
    char*    模块名;        /* 动态分配的字符串 */
    char*    字段名;        /* 动态分配的字符串 */
    uint8_t  导入类型;      /* 使用导出类型_xxx */
    uint32_t 索引;          /* 类型索引或全局索引等 */
};

typedef struct 结构_导入项 结构_导入项;

/* ==================== 函数结构 ==================== */
/* 函数定义 */
struct 结构_函数 {
    uint32_t 类型索引;
    uint32_t 局部变量数;
    uint8_t* 局部变量类型;  /* 动态数组，存储局部变量类型 */
    uint32_t 代码起始;      /* 在字节码中的起始位置 */
    uint32_t 代码结束;      /* 在字节码中的结束位置 */
    uint8_t* 函数体;        /* 指向字节码中的函数体 */
};

typedef struct 结构_函数 结构_函数;

/* ==================== 模块结构 ==================== */
/* WebAssembly 模块 */
struct 结构_模块 {
    /* 字节码 */
    uint8_t* 字节码;
    uint32_t 字节数;
    
    /* 段数据 */
    uint32_t        类型数;
    结构_函数类型*  类型列表;       /* 动态数组 */
    
    uint32_t        函数数;
    结构_函数*      函数列表;       /* 动态数组 */
    
    结构_表*        表;             /* 可为NULL */
    结构_内存*      内存;           /* 可为NULL */
    
    uint32_t        全局变量数;
    结构_全局变量*  全局变量列表;   /* 动态数组 */
    
    uint32_t        导出项数;
    结构_导出项*    导出列表;       /* 动态数组 */
    
    uint32_t        数据段数;
    结构_数据段*    数据段列表;     /* 动态数组 */
    
    uint32_t        元素段数;
    结构_元素段*    元素段列表;     /* 动态数组 */
    
    uint32_t        导入项数;
    结构_导入项*    导入列表;       /* 动态数组 */
    
    /* 统计信息 */
    uint32_t 导入函数数;
    int32_t  起始函数索引;          /* -1表示无起始函数 */
    
    /* 运行时状态 */
    uint32_t 程序计数器;
    int32_t  操作数栈指针;
    int32_t  帧指针;
    int32_t  块栈指针;
    
    /* 运行时数据结构 */
    结构_栈值*      操作数栈;       /* 预分配数组 */
    结构_栈帧*      调用栈;         /* 预分配数组 */
    结构_控制块*    块栈;           /* 预分配数组 */
    uint32_t*       分支表;         /* 预分配数组 */
    
    /* 栈大小配置 */
    uint32_t 操作数栈大小;
    uint32_t 调用栈大小;
    uint32_t 块栈大小;
    uint32_t 分支表大小;
};

typedef struct 结构_模块 结构_模块;

/* ==================== 解释器结构 ==================== */
/* WebAssembly 解释器 */
struct 结构_解释器 {
    结构_模块* 模块;
    int        运行中;      /* 布尔值 */
    int        调试模式;    /* 布尔值 */
};

typedef struct 结构_解释器 结构_解释器;

/* ==================== 函数声明 ==================== */

/* 栈值操作 */
结构_栈值 创建栈值(uint8_t 值类型, 联合体_值 值);
结构_栈值 创建栈值_整数32(int32_t 值);
结构_栈值 创建栈值_整数64(int64_t 值);
结构_栈值 创建栈值_单精度浮点(float 值);
结构_栈值 创建栈值_双精度浮点(double 值);

/* 模块操作 */
结构_模块* 创建模块(uint8_t* 字节码, uint32_t 字节数);
void 销毁模块(结构_模块* 模块);
int 初始化模块运行时(结构_模块* 模块);

/* 操作数栈操作 */
int 压入操作数(结构_模块* 模块, 结构_栈值 值);
int 弹出操作数(结构_模块* 模块, 结构_栈值* 输出);
int 查看栈顶(结构_模块* 模块, 结构_栈值* 输出);
int 查看栈顶偏移(结构_模块* 模块, int32_t 偏移, 结构_栈值* 输出);

/* 调用栈操作 */
int 压入帧(结构_模块* 模块, 结构_栈帧 帧);
int 弹出帧(结构_模块* 模块, 结构_栈帧* 输出);
结构_栈帧* 获取当前帧(结构_模块* 模块);

/* 块栈操作 */
int 压入块(结构_模块* 模块, 结构_控制块 块);
int 弹出块(结构_模块* 模块, 结构_控制块* 输出);
结构_控制块* 获取当前块(结构_模块* 模块);

/* 内存操作 */
结构_内存* 创建内存(uint32_t 初始页数, uint32_t 最大页数);
void 销毁内存(结构_内存* 内存);
int 内存增长(结构_内存* 内存, uint32_t 增量页数);

/* 表操作 */
结构_表* 创建表(uint32_t 初始大小, uint32_t 最大大小);
void 销毁表(结构_表* 表);

/* 字节码读取 */
uint8_t 读取字节(结构_模块* 模块);
int32_t 读取有符号32位(结构_模块* 模块);
uint32_t 读取无符号32位(结构_模块* 模块);
int64_t 读取有符号64位(结构_模块* 模块);
float 读取单精度浮点(结构_模块* 模块);
double 读取双精度浮点(结构_模块* 模块);

#endif /* 数据结构_H */
