"""
WebAssembly 模块加载器
对应原 module.c 文件
"""
import struct
from typing import Optional

from 枚举定义 import 值类型, 段类型, 导出类型, 块类型
from 数据结构 import (
    模块, 函数类型, 函数, 表, 内存, 全局变量, 
    导出项, 数据段, 元素段, 导入项
)
from 工具函数 import (
    解码无符号32位, 解码无符号64位, 
    解码有符号32位, 解码有符号64位,
    异常消息
)


class 模块加载器:
    """Wasm二进制模块加载器"""
    
    WASM魔数 = b'\x00asm'
    WASM版本 = 1
    
    def __init__(self):
        self.字节码: bytes = b''
        self.偏移 = 0
    
    def 加载模块(self, 字节码: bytes) -> 模块:
        """加载Wasm二进制模块"""
        self.字节码 = 字节码
        self.偏移 = 0
        
        # 验证魔数和版本
        self._验证头部()
        
        # 创建模块实例
        模块实例 = 模块(字节码)
        
        # 解析各个段
        while self.偏移 < len(字节码):
            段类型值 = self._读取字节()
            段长度, self.偏移 = 解码无符号32位(字节码, self.偏移)
            段结束 = self.偏移 + 段长度
            
            if 段类型值 == 段类型.自定义段:
                # 跳过自定义段
                self.偏移 = 段结束
            elif 段类型值 == 段类型.类型段:
                self._解析类型段(模块实例)
            elif 段类型值 == 段类型.导入段:
                self._解析导入段(模块实例)
            elif 段类型值 == 段类型.函数段:
                self._解析函数段(模块实例)
            elif 段类型值 == 段类型.表段:
                self._解析表段(模块实例)
            elif 段类型值 == 段类型.内存段:
                self._解析内存段(模块实例)
            elif 段类型值 == 段类型.全局段:
                self._解析全局段(模块实例)
            elif 段类型值 == 段类型.导出段:
                self._解析导出段(模块实例)
            elif 段类型值 == 段类型.起始段:
                self._解析起始段(模块实例)
            elif 段类型值 == 段类型.元素段:
                self._解析元素段(模块实例)
            elif 段类型值 == 段类型.代码段:
                self._解析代码段(模块实例)
            elif 段类型值 == 段类型.数据段:
                self._解析数据段(模块实例)
            else:
                raise ValueError(f"{异常消息.无效段}: {段类型值}")
            
            # 确保偏移正确
            self.偏移 = 段结束
        
        # 初始化数据段
        self._初始化数据段(模块实例)
        
        # 初始化元素段
        self._初始化元素段(模块实例)
        
        return 模块实例
    
    def _验证头部(self):
        """验证Wasm文件头部"""
        if self.偏移 + 8 > len(self.字节码):
            raise ValueError("文件太短")
        
        魔数 = self.字节码[self.偏移:self.偏移+4]
        if 魔数 != self.WASM魔数:
            raise ValueError(异常消息.无效魔数)
        self.偏移 += 4
        
        版本 = struct.unpack('<I', self.字节码[self.偏移:self.偏移+4])[0]
        if 版本 != self.WASM版本:
            raise ValueError(异常消息.无效版本)
        self.偏移 += 4
    
    def _读取字节(self) -> int:
        """读取单个字节"""
        if self.偏移 >= len(self.字节码):
            raise IndexError("超出字节码范围")
        字节 = self.字节码[self.偏移]
        self.偏移 += 1
        return 字节
    
    def _读取字符串(self) -> str:
        """读取字符串"""
        长度, self.偏移 = 解码无符号32位(self.字节码, self.偏移)
        字符串 = self.字节码[self.偏移:self.偏移+长度].decode('utf-8')
        self.偏移 += 长度
        return 字符串
    
    def _读取值类型(self) -> 值类型:
        """读取值类型"""
        类型字节 = self._读取字节()
        return 值类型(类型字节)
    
    def _解析类型段(self, 模块实例: 模块):
        """解析类型段"""
        类型数, self.偏移 = 解码无符号32位(self.字节码, self.偏移)
        
        for _ in range(类型数):
            形式 = self._读取字节()
            if 形式 != 0x60:
                raise ValueError(异常消息.无效类型)
            
            # 参数类型
            参数数, self.偏移 = 解码无符号32位(self.字节码, self.偏移)
            参数类型 = [self._读取值类型() for _ in range(参数数)]
            
            # 返回类型
            返回数, self.偏移 = 解码无符号32位(self.字节码, self.偏移)
            返回类型 = [self._读取值类型() for _ in range(返回数)]
            
            模块实例.类型列表.append(函数类型(参数类型, 返回类型))
    
    def _解析导入段(self, 模块实例: 模块):
        """解析导入段"""
        导入数, self.偏移 = 解码无符号32位(self.字节码, self.偏移)
        
        for _ in range(导入数):
            模块名 = self._读取字符串()
            字段名 = self._读取字符串()
            导入类型 = self._读取字节()
            
            if 导入类型 == 导出类型.函数导出:
                类型索引, self.偏移 = 解码无符号32位(self.字节码, self.偏移)
                模块实例.导入列表.append(导入项(模块名, 字段名, 导入类型, 类型索引))
                模块实例.导入函数数 += 1
            elif 导入类型 == 导出类型.表导出:
                元素类型 = self._读取字节()
                标志 = self._读取字节()
                if 标志 == 0:
                    初始大小, self.偏移 = 解码无符号32位(self.字节码, self.偏移)
                    最大大小 = 初始大小
                else:
                    初始大小, self.偏移 = 解码无符号32位(self.字节码, self.偏移)
                    最大大小, self.偏移 = 解码无符号32位(self.字节码, self.偏移)
                模块实例.表 = 表(初始大小, 最大大小)
            elif 导入类型 == 导出类型.内存导出:
                标志 = self._读取字节()
                if 标志 == 0:
                    初始页数, self.偏移 = 解码无符号32位(self.字节码, self.偏移)
                    最大页数 = 初始页数
                else:
                    初始页数, self.偏移 = 解码无符号32位(self.字节码, self.偏移)
                    最大页数, self.偏移 = 解码无符号32位(self.字节码, self.偏移)
                模块实例.内存 = 内存(初始页数, 最大页数)
            elif 导入类型 == 导出类型.全局导出:
                值类型 = self._读取值类型()
                可变性 = self._读取字节()
                # 全局初始化表达式将在后面处理
                # 这里先占位
                模块实例.全局变量列表.append(全局变量(值类型, 0, 可变性 == 1))
    
    def _解析函数段(self, 模块实例: 模块):
        """解析函数段"""
        函数数, self.偏移 = 解码无符号32位(self.字节码, self.偏移)
        
        for _ in range(函数数):
            类型索引, self.偏移 = 解码无符号32位(self.字节码, self.偏移)
            模块实例.函数列表.append(函数(类型索引, [], 0, 0))
        
        模块实例.函数数 = len(模块实例.函数列表)
    
    def _解析表段(self, 模块实例: 模块):
        """解析表段"""
        表数, self.偏移 = 解码无符号32位(self.字节码, self.偏移)
        
        for _ in range(表数):
            元素类型 = self._读取字节()
            标志 = self._读取字节()
            if 标志 == 0:
                初始大小, self.偏移 = 解码无符号32位(self.字节码, self.偏移)
                最大大小 = 初始大小
            else:
                初始大小, self.偏移 = 解码无符号32位(self.字节码, self.偏移)
                最大大小, self.偏移 = 解码无符号32位(self.字节码, self.偏移)
            模块实例.表 = 表(初始大小, 最大大小)
    
    def _解析内存段(self, 模块实例: 模块):
        """解析内存段"""
        内存数, self.偏移 = 解码无符号32位(self.字节码, self.偏移)
        
        for _ in range(内存数):
            标志 = self._读取字节()
            if 标志 == 0:
                初始页数, self.偏移 = 解码无符号32位(self.字节码, self.偏移)
                最大页数 = 初始页数
            else:
                初始页数, self.偏移 = 解码无符号32位(self.字节码, self.偏移)
                最大页数, self.偏移 = 解码无符号32位(self.字节码, self.偏移)
            模块实例.内存 = 内存(初始页数, 最大页数)
    
    def _解析全局段(self, 模块实例: 模块):
        """解析全局段"""
        全局数, self.偏移 = 解码无符号32位(self.字节码, self.偏移)
        
        for _ in range(全局数):
            值类型 = self._读取值类型()
            可变性 = self._读取字节()
            # 解析初始化表达式
            初始值 = self._解析初始化表达式(模块实例)
            模块实例.全局变量列表.append(全局变量(值类型, 初始值, 可变性 == 1))
    
    def _解析导出段(self, 模块实例: 模块):
        """解析导出段"""
        导出数, self.偏移 = 解码无符号32位(self.字节码, self.偏移)
        
        for _ in range(导出数):
            名称 = self._读取字符串()
            导出类型 = self._读取字节()
            索引, self.偏移 = 解码无符号32位(self.字节码, self.偏移)
            模块实例.导出列表.append(导出项(名称, 导出类型, 索引))
    
    def _解析起始段(self, 模块实例: 模块):
        """解析起始段"""
        模块实例.起始函数索引, self.偏移 = 解码无符号32位(self.字节码, self.偏移)
    
    def _解析元素段(self, 模块实例: 模块):
        """解析元素段"""
        元素数, self.偏移 = 解码无符号32位(self.字节码, self.偏移)
        
        for _ in range(元素数):
            表索引, self.偏移 = 解码无符号32位(self.字节码, self.偏移)
            # 解析偏移量初始化表达式
            偏移量 = self._解析初始化表达式(模块实例)
            # 解析函数索引列表
            函数索引数, self.偏移 = 解码无符号32位(self.字节码, self.偏移)
            函数索引列表 = []
            for _ in range(函数索引数):
                函数索引, self.偏移 = 解码无符号32位(self.字节码, self.偏移)
                函数索引列表.append(函数索引)
            模块实例.元素段列表.append(元素段(表索引, 偏移量, 函数索引列表))
    
    def _解析代码段(self, 模块实例: 模块):
        """解析代码段"""
        函数体数, self.偏移 = 解码无符号32位(self.字节码, self.偏移)
        
        for 函数索引 in range(函数体数):
            函数体大小, self.偏移 = 解码无符号32位(self.字节码, self.偏移)
            函数体起始 = self.偏移
            函数体结束 = self.偏移 + 函数体大小
            
            # 解析局部变量声明
            # 局部变量格式: vec(locals) 其中 locals = (count, type)
            局部变量组数, 局部变量偏移 = 解码无符号32位(self.字节码, 函数体起始)
            局部变量类型 = []
            
            # 更新偏移到局部变量声明之后
            当前偏移 = 局部变量偏移
            for _ in range(局部变量组数):
                计数, 当前偏移 = 解码无符号32位(self.字节码, 当前偏移)
                类型字节 = self.字节码[当前偏移]
                当前偏移 += 1
                类型 = 值类型(类型字节)
                for _ in range(计数):
                    局部变量类型.append(类型)
            
            # 代码起始位置是局部变量声明之后
            代码起始 = 当前偏移
            代码结束 = 函数体结束
            
            # 更新函数定义
            if 函数索引 < len(模块实例.函数列表):
                函数定义 = 模块实例.函数列表[函数索引]
                函数定义.局部变量类型 = 局部变量类型
                函数定义.代码起始 = 代码起始
                函数定义.代码结束 = 代码结束
                函数定义.函数体 = self.字节码[代码起始:代码结束]
            
            self.偏移 = 函数体结束
    
    def _解析数据段(self, 模块实例: 模块):
        """解析数据段"""
        数据段数, self.偏移 = 解码无符号32位(self.字节码, self.偏移)
        
        for _ in range(数据段数):
            内存索引, self.偏移 = 解码无符号32位(self.字节码, self.偏移)
            # 解析偏移量初始化表达式
            偏移量 = self._解析初始化表达式(模块实例)
            # 读取数据
            数据长度, self.偏移 = 解码无符号32位(self.字节码, self.偏移)
            数据 = self.字节码[self.偏移:self.偏移+数据长度]
            self.偏移 += 数据长度
            模块实例.数据段列表.append(数据段(内存索引, 偏移量, 数据))
    
    def _解析初始化表达式(self, 模块实例: 模块) -> int:
        """解析初始化表达式，返回i32常量值"""
        操作码 = self._读取字节()
        
        if 操作码 == 0x41:  # i32.const
            值, self.偏移 = 解码有符号32位(self.字节码, self.偏移)
        elif 操作码 == 0x42:  # i64.const
            值, self.偏移 = 解码有符号64位(self.字节码, self.偏移)
        elif 操作码 == 0x43:  # f32.const
            值 = struct.unpack('<f', self.字节码[self.偏移:self.偏移+4])[0]
            self.偏移 += 4
        elif 操作码 == 0x44:  # f64.const
            值 = struct.unpack('<d', self.字节码[self.偏移:self.偏移+8])[0]
            self.偏移 += 8
        elif 操作码 == 0x23:  # global.get
            全局索引, self.偏移 = 解码无符号32位(self.字节码, self.偏移)
            if 全局索引 < len(模块实例.全局变量列表):
                值 = 模块实例.全局变量列表[全局索引].值
            else:
                值 = 0
        else:
            raise ValueError(f"{异常消息.无效操作码}: {操作码}")
        
        # 检查结束标记
        结束标记 = self._读取字节()
        if 结束标记 != 0x0B:  # end
            raise ValueError("初始化表达式必须以end结束")
        
        return 值
    
    def _初始化数据段(self, 模块实例: 模块):
        """初始化数据段到内存"""
        if 模块实例.内存 is None:
            return
        
        for 数据段实例 in 模块实例.数据段列表:
            起始 = 数据段实例.偏移量
            结束 = 起始 + len(数据段实例.数据)
            if 结束 > len(模块实例.内存.数据):
                raise ValueError(异常消息.内存访问越界)
            模块实例.内存.数据[起始:结束] = 数据段实例.数据
    
    def _初始化元素段(self, 模块实例: 模块):
        """初始化元素段到表"""
        if 模块实例.表 is None:
            return
        
        for 元素段实例 in 模块实例.元素段列表:
            起始 = 元素段实例.偏移量
            for i, 函数索引 in enumerate(元素段实例.函数索引列表):
                if 起始 + i < len(模块实例.表.元素):
                    模块实例.表.元素[起始 + i] = 函数索引
